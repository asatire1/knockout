<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Tournament Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tier-elite { background-color: #DC2626; }
        .tier-advanced { background-color: #EA580C; }
        .tier-intermediate-plus { background-color: #CA8A04; }
        .tier-intermediate { background-color: #16A34A; }
        .tier-beginner-plus { background-color: #2563EB; }
        .tier-beginner { background-color: #7C3AED; }
        
        .match-within { border: 2px solid #7C3AED; }
        .match-cross { border: 2px solid #16A34A; }
        
        .tab-active { background-color: #3B82F6; color: white; }
        .tab-inactive { background-color: #E5E7EB; color: #374151; }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app"></div>

    <script>
        // ===== FIXTURES DATA =====
        const FIXTURES = {
            1: [
                { team1: [1, 4], team2: [2, 3] },
                { team1: [5, 8], team2: [6, 7] },
                { team1: [9, 12], team2: [10, 11] },
                { team1: [13, 16], team2: [14, 15] },
                { team1: [17, 20], team2: [18, 19] },
                { team1: [21, 24], team2: [22, 23] }
            ],
            2: [
                { team1: [1, 24], team2: [10, 16] },
                { team1: [2, 23], team2: [6, 19] },
                { team1: [3, 22], team2: [7, 18] },
                { team1: [4, 21], team2: [8, 17] },
                { team1: [5, 20], team2: [13, 12] },
                { team1: [11, 15], team2: [14, 9] }
            ],
            3: [
                { team1: [1, 10], team2: [9, 4] },
                { team1: [2, 11], team2: [12, 3] },
                { team1: [5, 18], team2: [13, 8] },
                { team1: [6, 17], team2: [14, 7] },
                { team1: [15, 24], team2: [19, 20] },
                { team1: [16, 23], team2: [22, 21] }
            ],
            4: [
                { team1: [1, 21], team2: [17, 2] },
                { team1: [4, 19], team2: [18, 3] },
                { team1: [5, 12], team2: [9, 8] },
                { team1: [6, 11], team2: [10, 7] },
                { team1: [13, 24], team2: [20, 16] },
                { team1: [14, 23], team2: [22, 15] }
            ],
            5: [
                { team1: [4, 14], team2: [13, 1] },
                { team1: [2, 16], team2: [15, 3] },
                { team1: [6, 24], team2: [21, 10] },
                { team1: [5, 23], team2: [11, 7] },
                { team1: [8, 22], team2: [17, 12] },
                { team1: [9, 19], team2: [18, 20] }
            ],
            6: [
                { team1: [1, 12], team2: [5, 4] },
                { team1: [2, 7], team2: [6, 3] },
                { team1: [9, 20], team2: [21, 8] },
                { team1: [10, 23], team2: [22, 11] },
                { team1: [13, 24], team2: [17, 18] },
                { team1: [14, 19], team2: [16, 15] }
            ],
            7: [
                { team1: [2, 24], team2: [5, 20] },
                { team1: [4, 23], team2: [6, 19] },
                { team1: [1, 22], team2: [7, 18] },
                { team1: [3, 21], team2: [8, 17] },
                { team1: [15, 16], team2: [13, 12] },
                { team1: [9, 11], team2: [14, 10] }
            ],
            8: [
                { team1: [5, 12], team2: [9, 4] },
                { team1: [1, 13], team2: [8, 2] },
                { team1: [6, 16], team2: [11, 10] },
                { team1: [3, 17], team2: [14, 7] },
                { team1: [21, 19], team2: [23, 20] },
                { team1: [22, 18], team2: [15, 24] }
            ],
            9: [
                { team1: [2, 24], team2: [17, 4] },
                { team1: [1, 19], team2: [18, 3] },
                { team1: [6, 12], team2: [11, 8] },
                { team1: [5, 9], team2: [10, 7] },
                { team1: [14, 20], team2: [21, 16] },
                { team1: [13, 23], team2: [22, 15] }
            ],
            10: [
                { team1: [2, 23], team2: [15, 5] },
                { team1: [1, 22], team2: [4, 20] },
                { team1: [8, 7], team2: [9, 18] },
                { team1: [12, 14], team2: [19, 13] },
                { team1: [3, 24], team2: [10, 17] },
                { team1: [11, 16], team2: [6, 21] }
            ],
            11: [
                { team1: [12, 22], team2: [16, 20] },
                { team1: [1, 23], team2: [6, 11] },
                { team1: [2, 9], team2: [7, 8] },
                { team1: [3, 21], team2: [5, 13] },
                { team1: [10, 18], team2: [14, 15] },
                { team1: [24, 4], team2: [19, 17] }
            ],
            12: [
                { team1: [2, 16], team2: [13, 4] },
                { team1: [5, 17], team2: [14, 1] },
                { team1: [6, 24], team2: [21, 8] },
                { team1: [3, 22], team2: [15, 7] },
                { team1: [10, 18], team2: [23, 12] },
                { team1: [9, 19], team2: [20, 11] }
            ],
            13: [
                { team1: [2, 8], team2: [5, 4] },
                { team1: [3, 7], team2: [6, 1] },
                { team1: [10, 24], team2: [21, 12] },
                { team1: [9, 23], team2: [15, 11] },
                { team1: [14, 20], team2: [17, 16] },
                { team1: [13, 19], team2: [18, 22] }
            ]
        };

        // ===== STATE MANAGEMENT =====
        class TournamentState {
            constructor() {
                this.loadFromStorage();
            }

            loadFromStorage() {
                // Initialize default skill ratings (3.75 to 2.75 in equal increments)
                const defaultRatings = {};
                for (let i = 1; i <= 24; i++) {
                    defaultRatings[i] = parseFloat((3.75 - (i - 1) * 0.043478).toFixed(2));
                }

                this.playerNames = JSON.parse(localStorage.getItem('padel_player_names')) || 
                    Array.from({length: 24}, (_, i) => `Player ${i + 1}`);
                
                this.skillRatings = JSON.parse(localStorage.getItem('padel_skill_ratings')) || defaultRatings;
                
                this.matchScores = JSON.parse(localStorage.getItem('padel_match_scores')) || {};
                
                this.knockoutScores = JSON.parse(localStorage.getItem('padel_knockout_scores')) || {};
                this.knockoutMaxScore = parseInt(localStorage.getItem('padel_knockout_max_score')) || 16;
                this.semiMaxScore = parseInt(localStorage.getItem('padel_semi_max_score')) || 16;
                this.finalMaxScore = parseInt(localStorage.getItem('padel_final_max_score')) || 16;
                
                this.savedVersions = JSON.parse(localStorage.getItem('padel_saved_versions')) || [];
                
                this.currentTab = 'fixtures';
                this.filterRound = 'all';
                this.filterPlayer = 'all';
            }

            saveToStorage() {
                localStorage.setItem('padel_player_names', JSON.stringify(this.playerNames));
                localStorage.setItem('padel_skill_ratings', JSON.stringify(this.skillRatings));
                localStorage.setItem('padel_match_scores', JSON.stringify(this.matchScores));
                localStorage.setItem('padel_knockout_scores', JSON.stringify(this.knockoutScores));
                localStorage.setItem('padel_knockout_max_score', this.knockoutMaxScore.toString());
                localStorage.setItem('padel_semi_max_score', this.semiMaxScore.toString());
                localStorage.setItem('padel_final_max_score', this.finalMaxScore.toString());
                localStorage.setItem('padel_saved_versions', JSON.stringify(this.savedVersions));
            }

            updatePlayerName(index, name) {
                this.playerNames[index] = name;
                this.saveToStorage();
            }

            updateSkillRating(playerId, rating) {
                this.skillRatings[playerId] = rating;
                this.saveToStorage();
            }

            updateMatchScore(round, match, team1Score, team2Score) {
                if (!this.matchScores[round]) {
                    this.matchScores[round] = {};
                }
                this.matchScores[round][match] = { team1Score, team2Score };
                this.saveToStorage();
            }

            clearMatchScore(round, match) {
                if (this.matchScores[round] && this.matchScores[round][match]) {
                    delete this.matchScores[round][match];
                    this.saveToStorage();
                }
            }

            updateKnockoutScore(matchId, team1Score, team2Score) {
                this.knockoutScores[matchId] = { team1Score, team2Score };
                this.saveToStorage();
            }

            clearKnockoutScore(matchId) {
                if (this.knockoutScores[matchId]) {
                    delete this.knockoutScores[matchId];
                    this.saveToStorage();
                }
            }

            updateKnockoutMaxScore(value) {
                this.knockoutMaxScore = value;
                this.saveToStorage();
            }

            updateSemiMaxScore(value) {
                this.semiMaxScore = value;
                this.saveToStorage();
            }

            updateFinalMaxScore(value) {
                this.finalMaxScore = value;
                this.saveToStorage();
            }

            resetAllScores() {
                // Auto-backup before reset
                this.createBackup('Auto-backup before reset');
                this.matchScores = {};
                this.saveToStorage();
            }

            createBackup(name) {
                const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19);
                const backup = {
                    id: Date.now(),
                    name: name || `Backup ${timestamp}`,
                    timestamp: timestamp,
                    playerNames: [...this.playerNames],
                    skillRatings: {...this.skillRatings},
                    matchScores: JSON.parse(JSON.stringify(this.matchScores)),
                    knockoutScores: JSON.parse(JSON.stringify(this.knockoutScores)),
                    knockoutMaxScore: this.knockoutMaxScore,
                    semiMaxScore: this.semiMaxScore,
                    finalMaxScore: this.finalMaxScore
                };
                
                this.savedVersions.unshift(backup);
                if (this.savedVersions.length > 10) {
                    this.savedVersions = this.savedVersions.slice(0, 10);
                }
                this.saveToStorage();
                return backup;
            }

            loadVersion(versionId) {
                const version = this.savedVersions.find(v => v.id === versionId);
                if (version) {
                    // Auto-backup current state
                    this.createBackup('Auto-backup before load');
                    
                    this.playerNames = [...version.playerNames];
                    this.skillRatings = {...version.skillRatings};
                    this.matchScores = JSON.parse(JSON.stringify(version.matchScores));
                    if (version.knockoutScores) this.knockoutScores = JSON.parse(JSON.stringify(version.knockoutScores));
                    if (version.knockoutMaxScore) this.knockoutMaxScore = version.knockoutMaxScore;
                    if (version.semiMaxScore) this.semiMaxScore = version.semiMaxScore;
                    if (version.finalMaxScore) this.finalMaxScore = version.finalMaxScore;
                    this.saveToStorage();
                }
            }

            deleteVersion(versionId) {
                this.savedVersions = this.savedVersions.filter(v => v.id !== versionId);
                this.saveToStorage();
            }

            exportData() {
                return {
                    exportDate: new Date().toISOString(),
                    playerNames: this.playerNames,
                    skillRatings: this.skillRatings,
                    matchScores: this.matchScores,
                    knockoutScores: this.knockoutScores,
                    knockoutMaxScore: this.knockoutMaxScore,
                    semiMaxScore: this.semiMaxScore,
                    finalMaxScore: this.finalMaxScore,
                    savedVersions: this.savedVersions
                };
            }

            importData(data) {
                if (data.playerNames) this.playerNames = data.playerNames;
                if (data.skillRatings) this.skillRatings = data.skillRatings;
                if (data.matchScores) this.matchScores = data.matchScores;
                if (data.knockoutScores) this.knockoutScores = data.knockoutScores;
                if (data.knockoutMaxScore) this.knockoutMaxScore = data.knockoutMaxScore;
                if (data.semiMaxScore) this.semiMaxScore = data.semiMaxScore;
                if (data.finalMaxScore) this.finalMaxScore = data.finalMaxScore;
                if (data.savedVersions) this.savedVersions = data.savedVersions;
                this.saveToStorage();
            }

            resetPlayerNames() {
                this.playerNames = Array.from({length: 24}, (_, i) => `Player ${i + 1}`);
                const defaultRatings = {};
                for (let i = 1; i <= 24; i++) {
                    defaultRatings[i] = parseFloat((3.75 - (i - 1) * 0.043478).toFixed(2));
                }
                this.skillRatings = defaultRatings;
                this.saveToStorage();
            }
        }

        const state = new TournamentState();

        // ===== UTILITY FUNCTIONS =====
        function getTier(playerId) {
            if (playerId >= 1 && playerId <= 4) return 'elite';
            if (playerId >= 5 && playerId <= 8) return 'advanced';
            if (playerId >= 9 && playerId <= 12) return 'intermediate-plus';
            if (playerId >= 13 && playerId <= 16) return 'intermediate';
            if (playerId >= 17 && playerId <= 20) return 'beginner-plus';
            return 'beginner';
        }

        function getTierName(playerId) {
            const tier = getTier(playerId);
            const names = {
                'elite': 'Elite',
                'advanced': 'Advanced',
                'intermediate-plus': 'Intermediate+',
                'intermediate': 'Intermediate',
                'beginner-plus': 'Beginner+',
                'beginner': 'Beginner'
            };
            return names[tier];
        }

        function isWithinGroup(match) {
            const allPlayers = [...match.team1, ...match.team2];
            const tier = getTier(allPlayers[0]);
            return allPlayers.every(p => getTier(p) === tier);
        }

        function getMatchScore(round, matchIdx) {
            return state.matchScores[round]?.[matchIdx] || { team1Score: null, team2Score: null };
        }

        function isMatchComplete(round, matchIdx) {
            const score = getMatchScore(round, matchIdx);
            return score.team1Score !== null && score.team2Score !== null;
        }

        function getWinner(round, matchIdx) {
            const score = getMatchScore(round, matchIdx);
            if (score.team1Score === null || score.team2Score === null) return null;
            if (score.team1Score > score.team2Score) return 'team1';
            if (score.team2Score > score.team1Score) return 'team2';
            return 'draw';
        }

        function countCompletedMatches() {
            let count = 0;
            for (let round = 1; round <= 13; round++) {
                for (let match = 0; match < 6; match++) {
                    if (isMatchComplete(round, match)) count++;
                }
            }
            return count;
        }

        // ===== COMPONENTS =====
        function PlayerBadge(playerId, showRating = false) {
            const tier = getTier(playerId);
            const name = state.playerNames[playerId - 1];
            const rating = state.skillRatings[playerId];
            
            return `
                <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-white text-xs tier-${tier}">
                    <span class="font-medium">#${playerId}</span>
                    <span>${name}</span>
                    ${showRating ? `<span class="opacity-90">(${rating})</span>` : ''}
                </div>
            `;
        }

        function MatchCard(round, matchIdx, match) {
            const within = isWithinGroup(match);
            const score = getMatchScore(round, matchIdx);
            const isComplete = isMatchComplete(round, matchIdx);
            const winner = getWinner(round, matchIdx);
            
            const team1Rating = (state.skillRatings[match.team1[0]] + state.skillRatings[match.team1[1]]).toFixed(2);
            const team2Rating = (state.skillRatings[match.team2[0]] + state.skillRatings[match.team2[1]]).toFixed(2);
            
            return `
                <div class="bg-white rounded-lg shadow-md overflow-hidden ${within ? 'match-within' : 'match-cross'}">
                    <!-- Header -->
                    <div class="bg-gray-100 px-4 py-2 flex justify-between items-center">
                        <div class="font-semibold text-gray-700">R${round} Match ${matchIdx + 1}</div>
                        <div class="text-xs px-2 py-1 rounded ${within ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}">
                            ${within ? 'Within Group' : 'Cross Group'}
                        </div>
                    </div>

                    <div class="p-4 space-y-3">
                        <!-- Team 1 -->
                        <div>
                            <div class="flex flex-wrap gap-2 mb-1">
                                ${PlayerBadge(match.team1[0])}
                                ${PlayerBadge(match.team1[1])}
                            </div>
                            <div class="text-xs text-gray-500">Total Rating: ${team1Rating}</div>
                        </div>

                        <!-- Score Input -->
                        <div class="flex items-center gap-2 bg-gray-50 p-2 rounded">
                            <input 
                                type="number" 
                                min="0" 
                                max="16" 
                                value="${score.team1Score !== null ? score.team1Score : ''}"
                                placeholder="0-16"
                                class="w-16 px-2 py-1 border rounded text-center"
                                onchange="handleScoreChange(${round}, ${matchIdx}, this.value, 1)"
                            />
                            <span class="text-gray-400">-</span>
                            <input 
                                type="number" 
                                min="0" 
                                max="16" 
                                value="${score.team2Score !== null ? score.team2Score : ''}"
                                placeholder="0-16"
                                class="w-16 px-2 py-1 border rounded text-center"
                                onchange="handleScoreChange(${round}, ${matchIdx}, this.value, 2)"
                            />
                            ${isComplete ? `
                                <button 
                                    onclick="clearScore(${round}, ${matchIdx})"
                                    class="ml-auto text-red-600 hover:text-red-800 font-bold"
                                    title="Clear score"
                                >√ó</button>
                            ` : ''}
                        </div>

                        <!-- Team 2 -->
                        <div>
                            <div class="flex flex-wrap gap-2 mb-1">
                                ${PlayerBadge(match.team2[0])}
                                ${PlayerBadge(match.team2[1])}
                            </div>
                            <div class="text-xs text-gray-500">Total Rating: ${team2Rating}</div>
                        </div>

                        <!-- Winner Display -->
                        ${isComplete ? `
                            <div class="mt-2 pt-2 border-t text-center">
                                ${winner === 'draw' ? 
                                    '<span class="text-sm font-semibold text-gray-600">ü§ù Draw!</span>' :
                                    `<span class="text-sm font-semibold text-green-600">üèÜ ${
                                        winner === 'team1' ? 
                                        `${state.playerNames[match.team1[0] - 1]} & ${state.playerNames[match.team1[1] - 1]}` :
                                        `${state.playerNames[match.team2[0] - 1]} & ${state.playerNames[match.team2[1] - 1]}`
                                    } Win!</span>`
                                }
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function TournamentFixturesTab() {
            const matches = [];
            
            for (let round = 1; round <= 13; round++) {
                if (state.filterRound !== 'all' && parseInt(state.filterRound) !== round) continue;
                
                FIXTURES[round].forEach((match, idx) => {
                    // Filter by player if selected
                    if (state.filterPlayer !== 'all') {
                        const playerId = parseInt(state.filterPlayer);
                        const allPlayers = [...match.team1, ...match.team2];
                        if (!allPlayers.includes(playerId)) return;
                    }
                    
                    matches.push({ round, idx, match });
                });
            }
            
            return `
                <div class="space-y-6">
                    <!-- Filters -->
                    <div class="bg-white rounded-lg shadow p-4 space-y-4">
                        <h3 class="font-semibold text-gray-700">Filters & Navigation</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Round:</label>
                                <select 
                                    class="w-full border rounded px-3 py-2"
                                    onchange="state.filterRound = this.value; render();"
                                >
                                    <option value="all" ${state.filterRound === 'all' ? 'selected' : ''}>All Rounds</option>
                                    ${Array.from({length: 13}, (_, i) => `
                                        <option value="${i + 1}" ${state.filterRound == (i + 1) ? 'selected' : ''}>Round ${i + 1}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Player:</label>
                                <select 
                                    class="w-full border rounded px-3 py-2"
                                    onchange="state.filterPlayer = this.value; render();"
                                >
                                    <option value="all" ${state.filterPlayer === 'all' ? 'selected' : ''}>All Players</option>
                                    ${Array.from({length: 24}, (_, i) => `
                                        <option value="${i + 1}" ${state.filterPlayer == (i + 1) ? 'selected' : ''}>
                                            #${i + 1} ${state.playerNames[i]}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <button 
                            onclick="state.filterRound = 'all'; state.filterPlayer = 'all'; render();"
                            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm"
                        >
                            Clear Filters
                        </button>
                        
                        <!-- Quick Round Navigation -->
                        <div>
                            <div class="text-sm font-medium text-gray-700 mb-2">Quick Navigation:</div>
                            <div class="flex flex-wrap gap-2">
                                ${Array.from({length: 13}, (_, i) => `
                                    <button 
                                        onclick="state.filterRound = '${i + 1}'; render();"
                                        class="px-3 py-1 rounded text-sm ${state.filterRound == (i + 1) ? 'bg-blue-500 text-white' : 'bg-gray-200 hover:bg-gray-300'}"
                                    >
                                        R${i + 1}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Matches Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${matches.map(m => MatchCard(m.round, m.idx, m.match)).join('')}
                    </div>
                    
                    ${matches.length === 0 ? `
                        <div class="text-center py-12 text-gray-500">
                            No matches found with current filters.
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function PlayersTab() {
            return `
                <div class="space-y-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-900 mb-2">üí° Player Tiers</h3>
                        <div class="text-sm text-blue-800 space-y-1">
                            <div><strong>Elite (#1-4):</strong> Highest skilled players</div>
                            <div><strong>Advanced (#5-8):</strong> Very skilled players</div>
                            <div><strong>Intermediate+ (#9-12):</strong> Above average players</div>
                            <div><strong>Intermediate (#13-16):</strong> Average players</div>
                            <div><strong>Beginner+ (#17-20):</strong> Developing players</div>
                            <div><strong>Beginner (#21-24):</strong> Newest players</div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button 
                            onclick="if(confirm('Reset all player names and ratings to defaults?')) { state.resetPlayerNames(); render(); }"
                            class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded"
                        >
                            Reset All Names
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${Array.from({length: 24}, (_, i) => {
                            const playerId = i + 1;
                            const tier = getTier(playerId);
                            const tierName = getTierName(playerId);
                            
                            return `
                                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                                    <div class="tier-${tier} px-4 py-2 text-white font-semibold">
                                        #${playerId} - ${tierName}
                                    </div>
                                    <div class="p-4 space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                Player Name:
                                            </label>
                                            <input 
                                                type="text" 
                                                value="${state.playerNames[i]}"
                                                class="w-full border rounded px-3 py-2"
                                                onchange="state.updatePlayerName(${i}, this.value); render();"
                                            />
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                Skill Rating:
                                            </label>
                                            <input 
                                                type="number" 
                                                min="0" 
                                                max="5" 
                                                step="0.05"
                                                value="${state.skillRatings[playerId]}"
                                                class="w-full border rounded px-3 py-2"
                                                onchange="state.updateSkillRating(${playerId}, parseFloat(this.value)); render();"
                                            />
                                            <div class="text-xs text-gray-500 mt-1">(0-5, step 0.05)</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function DataManagementTab() {
            const completedMatches = countCompletedMatches();
            
            return `
                <div class="space-y-6">
                    <!-- Export -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">üíæ Export Tournament Data</h3>
                        <p class="text-sm text-gray-600 mb-4">Download all data as JSON file</p>
                        <button 
                            onclick="exportData()"
                            class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium"
                        >
                            Download Data File
                        </button>
                    </div>
                    
                    <!-- Import -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">üìÇ Import Tournament Data</h3>
                        <p class="text-sm text-gray-600 mb-4">Upload previously exported JSON</p>
                        <input 
                            type="file" 
                            accept=".json"
                            onchange="importData(this.files[0])"
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                        />
                    </div>
                    
                    <!-- Reset Scores -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">‚ö†Ô∏è Reset Match Scores</h3>
                        <p class="text-sm text-gray-600 mb-4">Clear all scores, auto-save backup first</p>
                        <button 
                            onclick="resetScores()"
                            class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium"
                        >
                            Reset All Scores
                        </button>
                    </div>
                    
                    <!-- Save Backup -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">üíæ Save Current Version</h3>
                        <p class="text-sm text-gray-600 mb-4">Create named backup</p>
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="backup-name"
                                placeholder="Enter backup name..."
                                class="flex-1 border rounded px-3 py-2"
                            />
                            <button 
                                onclick="saveBackup()"
                                class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded font-medium"
                            >
                                Save Backup
                            </button>
                        </div>
                    </div>
                    
                    <!-- Saved Versions -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">
                            Saved Versions (${state.savedVersions.length}/10)
                        </h3>
                        
                        ${state.savedVersions.length === 0 ? `
                            <p class="text-sm text-gray-500">No saved versions yet.</p>
                        ` : `
                            <div class="space-y-3">
                                ${state.savedVersions.map(version => `
                                    <div class="border rounded-lg p-4">
                                        <div class="font-medium text-gray-800">${version.name}</div>
                                        <div class="text-sm text-gray-500">${version.timestamp}</div>
                                        <div class="text-sm text-gray-600 mt-1">
                                            ${Object.values(version.matchScores).reduce((sum, round) => sum + Object.keys(round).length, 0)} matches recorded
                                        </div>
                                        <div class="flex gap-2 mt-3">
                                            <button 
                                                onclick="loadVersion(${version.id})"
                                                class="px-4 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm"
                                            >
                                                Load
                                            </button>
                                            <button 
                                                onclick="deleteVersion(${version.id})"
                                                class="px-4 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm"
                                            >
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // ===== STAGE 2: CALCULATIONS =====
        function calculateStandings() {
            const standings = [];
            
            for (let playerId = 1; playerId <= 24; playerId++) {
                let matches = 0, wins = 0, draws = 0, losses = 0;
                let pointsFor = 0, pointsAgainst = 0;
                let tournamentPoints = 0;
                const partners = new Set();
                
                // Check all matches for this player
                for (let round = 1; round <= 13; round++) {
                    FIXTURES[round].forEach((match, matchIdx) => {
                        const allPlayers = [...match.team1, ...match.team2];
                        if (!allPlayers.includes(playerId)) return;
                        
                        const score = getMatchScore(round, matchIdx);
                        if (score.team1Score === null || score.team2Score === null) return;
                        
                        matches++;
                        
                        // Determine if player is in team1 or team2
                        const isTeam1 = match.team1.includes(playerId);
                        const playerScore = isTeam1 ? score.team1Score : score.team2Score;
                        const opponentScore = isTeam1 ? score.team2Score : score.team1Score;
                        
                        pointsFor += playerScore;
                        pointsAgainst += opponentScore;
                        
                        // Track partner
                        const partner = isTeam1 ? 
                            match.team1.find(p => p !== playerId) : 
                            match.team2.find(p => p !== playerId);
                        partners.add(partner);
                        
                        // Determine result
                        if (playerScore > opponentScore) {
                            wins++;
                            tournamentPoints += 3;
                        } else if (playerScore === opponentScore) {
                            draws++;
                            tournamentPoints += 1;
                        } else {
                            losses++;
                        }
                    });
                }
                
                standings.push({
                    playerId,
                    name: state.playerNames[playerId - 1],
                    rating: state.skillRatings[playerId],
                    matches,
                    wins,
                    draws,
                    losses,
                    pointsFor,
                    pointsAgainst,
                    pointsDiff: pointsFor - pointsAgainst,
                    tournamentPoints,
                    winRate: matches > 0 ? (wins / matches * 100).toFixed(1) : '0.0',
                    uniquePartners: partners.size
                });
            }
            
            // Sort by: Tournament Points (desc), Points Diff (desc), Points For (desc)
            standings.sort((a, b) => {
                if (b.tournamentPoints !== a.tournamentPoints) return b.tournamentPoints - a.tournamentPoints;
                if (b.pointsDiff !== a.pointsDiff) return b.pointsDiff - a.pointsDiff;
                return b.pointsFor - a.pointsFor;
            });
            
            return standings;
        }

        function calculateFairness() {
            const fairness = [];
            
            for (let playerId = 1; playerId <= 24; playerId++) {
                const roundScores = [];
                let totalFairness = 0;
                
                for (let round = 1; round <= 13; round++) {
                    let roundFairness = null;
                    
                    FIXTURES[round].forEach((match) => {
                        const allPlayers = [...match.team1, ...match.team2];
                        if (!allPlayers.includes(playerId)) return;
                        
                        const isTeam1 = match.team1.includes(playerId);
                        const partner = isTeam1 ? 
                            match.team1.find(p => p !== playerId) : 
                            match.team2.find(p => p !== playerId);
                        const opponents = isTeam1 ? match.team2 : match.team1;
                        
                        const myTeamRating = state.skillRatings[playerId] + state.skillRatings[partner];
                        const opponentRating = state.skillRatings[opponents[0]] + state.skillRatings[opponents[1]];
                        
                        roundFairness = myTeamRating - opponentRating;
                    });
                    
                    if (roundFairness !== null) {
                        roundScores.push(roundFairness);
                        totalFairness += roundFairness;
                    }
                }
                
                const avgFairness = roundScores.length > 0 ? totalFairness / roundScores.length : 0;
                const hardestRound = roundScores.length > 0 ? Math.min(...roundScores) : 0;
                const easiestRound = roundScores.length > 0 ? Math.max(...roundScores) : 0;
                
                fairness.push({
                    playerId,
                    name: state.playerNames[playerId - 1],
                    rating: state.skillRatings[playerId],
                    totalFairness,
                    avgFairness,
                    hardestRound,
                    easiestRound,
                    roundScores
                });
            }
            
            return fairness;
        }

        function calculateFairness2() {
            const fairness2 = [];
            
            for (let playerId = 1; playerId <= 24; playerId++) {
                const roundScores = [];
                let totalFairness = 0;
                
                for (let round = 1; round <= 13; round++) {
                    let roundFairness = null;
                    
                    FIXTURES[round].forEach((match) => {
                        const allPlayers = [...match.team1, ...match.team2];
                        if (!allPlayers.includes(playerId)) return;
                        
                        const isTeam1 = match.team1.includes(playerId);
                        const partner = isTeam1 ? 
                            match.team1.find(p => p !== playerId) : 
                            match.team2.find(p => p !== playerId);
                        const opponents = isTeam1 ? match.team2 : match.team1;
                        
                        const partnerRating = state.skillRatings[partner];
                        const avgOpponentRating = (state.skillRatings[opponents[0]] + state.skillRatings[opponents[1]]) / 2;
                        
                        roundFairness = partnerRating - avgOpponentRating;
                    });
                    
                    if (roundFairness !== null) {
                        roundScores.push(roundFairness);
                        totalFairness += roundFairness;
                    }
                }
                
                const avgFairness = roundScores.length > 0 ? totalFairness / roundScores.length : 0;
                const hardestRound = roundScores.length > 0 ? Math.min(...roundScores) : 0;
                const easiestRound = roundScores.length > 0 ? Math.max(...roundScores) : 0;
                
                fairness2.push({
                    playerId,
                    name: state.playerNames[playerId - 1],
                    rating: state.skillRatings[playerId],
                    totalFairness,
                    avgFairness,
                    hardestRound,
                    easiestRound,
                    roundScores
                });
            }
            
            return fairness2;
        }

        function ResultsTab() {
            const standings = calculateStandings();
            
            return `
                <div class="space-y-6">
                    <!-- Point System -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-900 mb-2">Tournament Point System</h3>
                        <div class="text-sm text-blue-800">
                            <strong>Win:</strong> 3 points | <strong>Draw:</strong> 1 point | <strong>Loss:</strong> 0 points
                        </div>
                    </div>
                    
                    <!-- Standings Table -->
                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 border-b-2">
                                <tr>
                                    <th class="px-4 py-3 text-left">Rank</th>
                                    <th class="px-4 py-3 text-left">Player</th>
                                    <th class="px-4 py-3 text-center">Pts</th>
                                    <th class="px-4 py-3 text-center">M</th>
                                    <th class="px-4 py-3 text-center">W</th>
                                    <th class="px-4 py-3 text-center">D</th>
                                    <th class="px-4 py-3 text-center">L</th>
                                    <th class="px-4 py-3 text-center">Win%</th>
                                    <th class="px-4 py-3 text-center">For</th>
                                    <th class="px-4 py-3 text-center">Ag</th>
                                    <th class="px-4 py-3 text-center">Diff</th>
                                    <th class="px-4 py-3 text-center">Partners</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${standings.map((player, idx) => `
                                    <tr class="border-b hover:bg-gray-50 ${idx < 3 ? 'bg-yellow-50' : ''}">
                                        <td class="px-4 py-3 font-semibold">
                                            ${idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : idx + 1}
                                        </td>
                                        <td class="px-4 py-3">
                                            ${PlayerBadge(player.playerId, true)}
                                        </td>
                                        <td class="px-4 py-3 text-center font-bold">${player.tournamentPoints}</td>
                                        <td class="px-4 py-3 text-center">${player.matches}</td>
                                        <td class="px-4 py-3 text-center text-green-600 font-medium">${player.wins}</td>
                                        <td class="px-4 py-3 text-center text-gray-600">${player.draws}</td>
                                        <td class="px-4 py-3 text-center text-red-600 font-medium">${player.losses}</td>
                                        <td class="px-4 py-3 text-center">${player.winRate}%</td>
                                        <td class="px-4 py-3 text-center">${player.pointsFor}</td>
                                        <td class="px-4 py-3 text-center">${player.pointsAgainst}</td>
                                        <td class="px-4 py-3 text-center ${player.pointsDiff > 0 ? 'text-green-600 font-medium' : player.pointsDiff < 0 ? 'text-red-600 font-medium' : ''}">
                                            ${player.pointsDiff > 0 ? '+' : ''}${player.pointsDiff}
                                        </td>
                                        <td class="px-4 py-3 text-center">${player.uniquePartners}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function FairnessTab() {
            const fairness = calculateFairness();
            
            // Calculate distribution
            let harder = 0, balanced = 0, easier = 0;
            fairness.forEach(f => {
                if (f.avgFairness < -0.1) harder++;
                else if (f.avgFairness > 0.1) easier++;
                else balanced++;
            });
            
            return `
                <div class="space-y-6">
                    <!-- Explanation -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-900 mb-2">How Fairness is Calculated</h3>
                        <div class="text-sm text-blue-800 space-y-1">
                            <div><strong>Fairness = Your Team Rating - Opponent Team Rating</strong></div>
                            <div class="mt-2">
                                <span class="text-red-600 font-medium">Negative:</span> You had harder opponents (tougher schedule)<br>
                                <span class="text-green-600 font-medium">Positive:</span> You had easier opponents (easier schedule)<br>
                                <span class="text-gray-600 font-medium">Zero:</span> Perfectly balanced schedule
                            </div>
                        </div>
                    </div>
                    
                    <!-- Distribution Summary -->
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">Schedule Distribution</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="w-32 font-medium text-red-600">${harder} Players</span>
                                <span class="text-gray-600">with Harder Schedule (avg < -0.1)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-32 font-medium text-gray-600">${balanced} Players</span>
                                <span class="text-gray-600">with Balanced Schedule (-0.1 to 0.1)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-32 font-medium text-green-600">${easier} Players</span>
                                <span class="text-gray-600">with Easier Schedule (avg > 0.1)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fairness Table -->
                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 border-b-2">
                                <tr>
                                    <th class="px-4 py-3 text-left">Player</th>
                                    <th class="px-4 py-3 text-center">Rating</th>
                                    <th class="px-4 py-3 text-center">Total</th>
                                    <th class="px-4 py-3 text-center">Average</th>
                                    <th class="px-4 py-3 text-center">Hardest</th>
                                    <th class="px-4 py-3 text-center">Easiest</th>
                                    <th class="px-4 py-3 text-left">All Rounds</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${fairness.map(f => {
                                    const avgColor = f.avgFairness < -0.1 ? 'text-red-600' : f.avgFairness > 0.1 ? 'text-green-600' : 'text-gray-600';
                                    
                                    return `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="px-4 py-3">
                                                ${PlayerBadge(f.playerId)}
                                            </td>
                                            <td class="px-4 py-3 text-center">${f.rating.toFixed(2)}</td>
                                            <td class="px-4 py-3 text-center ${avgColor} font-medium">
                                                ${f.totalFairness > 0 ? '+' : ''}${f.totalFairness.toFixed(2)}
                                            </td>
                                            <td class="px-4 py-3 text-center ${avgColor} font-bold">
                                                ${f.avgFairness > 0 ? '+' : ''}${f.avgFairness.toFixed(2)}
                                            </td>
                                            <td class="px-4 py-3 text-center text-red-600">
                                                ${f.hardestRound.toFixed(2)}
                                            </td>
                                            <td class="px-4 py-3 text-center text-green-600">
                                                ${f.easiestRound > 0 ? '+' : ''}${f.easiestRound.toFixed(2)}
                                            </td>
                                            <td class="px-4 py-3">
                                                <div class="flex flex-wrap gap-1">
                                                    ${f.roundScores.map((score, idx) => {
                                                        const color = score < -0.1 ? 'bg-red-100 text-red-700' : 
                                                                     score > 0.1 ? 'bg-green-100 text-green-700' : 
                                                                     'bg-gray-100 text-gray-700';
                                                        return `
                                                            <span class="px-2 py-1 rounded text-xs ${color}" title="Round ${idx + 1}: ${score > 0 ? '+' : ''}${score.toFixed(2)}">
                                                                ${score > 0 ? '+' : ''}${score.toFixed(1)}
                                                            </span>
                                                        `;
                                                    }).join('')}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function Fairness2Tab() {
            const fairness2 = calculateFairness2();
            
            // Calculate distribution
            let harder = 0, balanced = 0, easier = 0;
            fairness2.forEach(f => {
                if (f.avgFairness < -0.05) harder++;
                else if (f.avgFairness > 0.05) easier++;
                else balanced++;
            });
            
            return `
                <div class="space-y-6">
                    <!-- Explanation -->
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <h3 class="font-semibold text-purple-900 mb-2">Fairness 2: Partner Quality vs Opponents</h3>
                        <div class="text-sm text-purple-800 space-y-1">
                            <div><strong>Fairness 2 = Partner Rating - Average Opponent Rating</strong></div>
                            <div class="mt-2">
                                <span class="text-red-600 font-medium">Negative:</span> Your partner was weaker than average opponent<br>
                                <span class="text-green-600 font-medium">Positive:</span> Your partner was stronger than average opponent<br>
                                <span class="text-gray-600 font-medium">Zero:</span> Partner matched opponent average
                            </div>
                        </div>
                    </div>
                    
                    <!-- Distribution Summary -->
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">Partner Quality Distribution</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="w-32 font-medium text-red-600">${harder} Players</span>
                                <span class="text-gray-600">had Weaker Partners (avg < -0.05)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-32 font-medium text-gray-600">${balanced} Players</span>
                                <span class="text-gray-600">had Balanced Partners (-0.05 to 0.05)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-32 font-medium text-green-600">${easier} Players</span>
                                <span class="text-gray-600">had Stronger Partners (avg > 0.05)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fairness 2 Table -->
                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 border-b-2">
                                <tr>
                                    <th class="px-4 py-3 text-left">Player</th>
                                    <th class="px-4 py-3 text-center">Rating</th>
                                    <th class="px-4 py-3 text-center">Total</th>
                                    <th class="px-4 py-3 text-center">Average</th>
                                    <th class="px-4 py-3 text-center">Worst</th>
                                    <th class="px-4 py-3 text-center">Best</th>
                                    <th class="px-4 py-3 text-left">All Rounds</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${fairness2.map(f => {
                                    const avgColor = f.avgFairness < -0.05 ? 'text-red-600' : f.avgFairness > 0.05 ? 'text-green-600' : 'text-gray-600';
                                    
                                    return `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="px-4 py-3">
                                                ${PlayerBadge(f.playerId)}
                                            </td>
                                            <td class="px-4 py-3 text-center">${f.rating.toFixed(2)}</td>
                                            <td class="px-4 py-3 text-center ${avgColor} font-medium">
                                                ${f.totalFairness > 0 ? '+' : ''}${f.totalFairness.toFixed(2)}
                                            </td>
                                            <td class="px-4 py-3 text-center ${avgColor} font-bold">
                                                ${f.avgFairness > 0 ? '+' : ''}${f.avgFairness.toFixed(2)}
                                            </td>
                                            <td class="px-4 py-3 text-center text-red-600">
                                                ${f.hardestRound.toFixed(2)}
                                            </td>
                                            <td class="px-4 py-3 text-center text-green-600">
                                                ${f.easiestRound > 0 ? '+' : ''}${f.easiestRound.toFixed(2)}
                                            </td>
                                            <td class="px-4 py-3">
                                                <div class="flex flex-wrap gap-1">
                                                    ${f.roundScores.map((score, idx) => {
                                                        const color = score < -0.05 ? 'bg-red-100 text-red-700' : 
                                                                     score > 0.05 ? 'bg-green-100 text-green-700' : 
                                                                     'bg-gray-100 text-gray-700';
                                                        return `
                                                            <span class="px-2 py-1 rounded text-xs ${color}" title="Round ${idx + 1}: ${score > 0 ? '+' : ''}${score.toFixed(2)}">
                                                                ${score > 0 ? '+' : ''}${score.toFixed(1)}
                                                            </span>
                                                        `;
                                                    }).join('')}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // ===== STAGE 3: PARTNERSHIPS & KNOCKOUT =====
        function calculatePartnerships() {
            const partnerships = {};
            const opponents = {};
            
            // Initialize matrices
            for (let i = 1; i <= 24; i++) {
                partnerships[i] = {};
                opponents[i] = {};
                for (let j = 1; j <= 24; j++) {
                    partnerships[i][j] = 0;
                    opponents[i][j] = 0;
                }
            }
            
            // Count partnerships and opponents
            for (let round = 1; round <= 13; round++) {
                FIXTURES[round].forEach((match) => {
                    const [p1, p2] = match.team1;
                    const [p3, p4] = match.team2;
                    
                    // Partnerships
                    partnerships[p1][p2]++;
                    partnerships[p2][p1]++;
                    partnerships[p3][p4]++;
                    partnerships[p4][p3]++;
                    
                    // Opponents
                    [p1, p2].forEach(p => {
                        opponents[p][p3]++;
                        opponents[p][p4]++;
                    });
                    [p3, p4].forEach(p => {
                        opponents[p][p1]++;
                        opponents[p][p2]++;
                    });
                });
            }
            
            // Calculate statistics
            let totalPartnerships = 0, uniquePartnerships = 0;
            let totalOpponents = 0, uniqueOpponents = 0;
            
            for (let i = 1; i <= 24; i++) {
                for (let j = i + 1; j <= 24; j++) {
                    if (partnerships[i][j] > 0) {
                        totalPartnerships += partnerships[i][j];
                        uniquePartnerships++;
                    }
                    if (opponents[i][j] > 0) {
                        totalOpponents += opponents[i][j];
                        uniqueOpponents++;
                    }
                }
            }
            
            return {
                partnerships,
                opponents,
                stats: {
                    totalPartnerships: totalPartnerships * 2, // Each partnership counted from both sides
                    uniquePartnerships,
                    totalOpponents: totalOpponents * 2,
                    uniqueOpponents,
                    partnershipCoverage: (uniquePartnerships / 276 * 100).toFixed(1), // 24*23/2 = 276 possible
                    opponentCoverage: (uniqueOpponents / 276 * 100).toFixed(1)
                }
            };
        }

        function PartnershipsTab() {
            const data = calculatePartnerships();
            
            return `
                <div class="space-y-6">
                    <!-- Statistics Summary -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-900 mb-3">Partnership & Opponent Statistics</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="font-medium text-blue-900">Partnerships</div>
                                <div class="text-blue-800">
                                    ${data.stats.totalPartnerships} Total | 
                                    ${data.stats.uniquePartnerships} Unique (${data.stats.partnershipCoverage}%)
                                </div>
                            </div>
                            <div>
                                <div class="font-medium text-blue-900">Opponents</div>
                                <div class="text-blue-800">
                                    ${data.stats.totalOpponents} Total | 
                                    ${data.stats.uniqueOpponents} Unique (${data.stats.opponentCoverage}%)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Partnership Matrix -->
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">Partnership Matrix</h3>
                        <div class="text-xs text-gray-600 mb-3">
                            <span class="inline-block w-6 h-6 bg-blue-200 border mr-1"></span> 1 partnership
                            <span class="inline-block w-6 h-6 bg-green-300 border mr-1 ml-3"></span> 2 partnerships
                            <span class="inline-block w-6 h-6 bg-red-300 border mr-1 ml-3"></span> 3+ partnerships
                        </div>
                        <div class="overflow-x-auto">
                            <table class="text-xs border-collapse">
                                <thead>
                                    <tr>
                                        <th class="border p-1 bg-gray-100 sticky left-0"></th>
                                        ${Array.from({length: 24}, (_, i) => `
                                            <th class="border p-1 bg-gray-100 text-center">${i + 1}</th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Array.from({length: 24}, (_, i) => {
                                        const playerId = i + 1;
                                        return `
                                            <tr>
                                                <th class="border p-1 bg-gray-100 sticky left-0 text-right">${playerId}</th>
                                                ${Array.from({length: 24}, (_, j) => {
                                                    const partnerId = j + 1;
                                                    if (playerId === partnerId) {
                                                        return `<td class="border p-1 bg-gray-200 text-center">-</td>`;
                                                    }
                                                    const count = data.partnerships[playerId][partnerId];
                                                    const bgColor = count === 0 ? 'bg-white' : 
                                                                   count === 1 ? 'bg-blue-200' : 
                                                                   count === 2 ? 'bg-green-300' : 'bg-red-300';
                                                    return `
                                                        <td class="border p-1 text-center ${bgColor}" title="Player ${playerId} partnered with Player ${partnerId}: ${count} times">
                                                            ${count > 0 ? count : ''}
                                                        </td>
                                                    `;
                                                }).join('')}
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Opponent Matrix -->
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">Opponent Matrix</h3>
                        <div class="text-xs text-gray-600 mb-3">
                            <span class="inline-block w-6 h-6 bg-red-100 border mr-1"></span> 1-2 times
                            <span class="inline-block w-6 h-6 bg-orange-200 border mr-1 ml-3"></span> 3-4 times
                            <span class="inline-block w-6 h-6 bg-yellow-200 border mr-1 ml-3"></span> 5-6 times
                            <span class="inline-block w-6 h-6 bg-purple-300 border mr-1 ml-3"></span> 7+ times
                        </div>
                        <div class="overflow-x-auto">
                            <table class="text-xs border-collapse">
                                <thead>
                                    <tr>
                                        <th class="border p-1 bg-gray-100 sticky left-0"></th>
                                        ${Array.from({length: 24}, (_, i) => `
                                            <th class="border p-1 bg-gray-100 text-center">${i + 1}</th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Array.from({length: 24}, (_, i) => {
                                        const playerId = i + 1;
                                        return `
                                            <tr>
                                                <th class="border p-1 bg-gray-100 sticky left-0 text-right">${playerId}</th>
                                                ${Array.from({length: 24}, (_, j) => {
                                                    const opponentId = j + 1;
                                                    if (playerId === opponentId) {
                                                        return `<td class="border p-1 bg-gray-200 text-center">-</td>`;
                                                    }
                                                    const count = data.opponents[playerId][opponentId];
                                                    const bgColor = count === 0 ? 'bg-white' : 
                                                                   count <= 2 ? 'bg-red-100' : 
                                                                   count <= 4 ? 'bg-orange-200' : 
                                                                   count <= 6 ? 'bg-yellow-200' : 'bg-purple-300';
                                                    return `
                                                        <td class="border p-1 text-center ${bgColor}" title="Player ${playerId} opposed Player ${opponentId}: ${count} times">
                                                            ${count > 0 ? count : ''}
                                                        </td>
                                                    `;
                                                }).join('')}
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function KnockoutTab() {
            const standings = calculateStandings();
            const top12 = standings.slice(0, 12);
            
            // Get knockout scores
            const getKOScore = (matchId) => state.knockoutScores[matchId] || { team1Score: null, team2Score: null };
            
            const qf1 = getKOScore('qf1');
            const qf2 = getKOScore('qf2');
            const qf3 = getKOScore('qf3');
            const qf4 = getKOScore('qf4');
            const sf1 = getKOScore('sf1');
            const sf2 = getKOScore('sf2');
            const final = getKOScore('final');
            
            // Determine winners
            const qf1Winner = qf1.team1Score !== null && qf1.team2Score !== null ? 
                (qf1.team1Score > qf1.team2Score ? 'team1' : 'team2') : null;
            const qf2Winner = qf2.team1Score !== null && qf2.team2Score !== null ? 
                (qf2.team1Score > qf2.team2Score ? 'team1' : 'team2') : null;
            const qf3Winner = qf3.team1Score !== null && qf3.team2Score !== null ? 
                (qf3.team1Score > qf3.team2Score ? 'team1' : 'team2') : null;
            const qf4Winner = qf4.team1Score !== null && qf4.team2Score !== null ? 
                (qf4.team1Score > qf4.team2Score ? 'team1' : 'team2') : null;
            const sf1Winner = sf1.team1Score !== null && sf1.team2Score !== null ? 
                (sf1.team1Score > sf1.team2Score ? 'team1' : 'team2') : null;
            const sf2Winner = sf2.team1Score !== null && sf2.team2Score !== null ? 
                (sf2.team1Score > sf2.team2Score ? 'team1' : 'team2') : null;
            const champion = final.team1Score !== null && final.team2Score !== null ? 
                (final.team1Score > final.team2Score ? 'team1' : 'team2') : null;
            
            function KnockoutMatchCard(title, matchId, team1Players, team2Players, maxScore) {
                const score = getKOScore(matchId);
                const isComplete = score.team1Score !== null && score.team2Score !== null;
                const winner = isComplete ? 
                    (score.team1Score > score.team2Score ? 'team1' : 'team2') : null;
                
                return `
                    <div class="bg-white rounded-lg shadow-md p-4 border-2 ${isComplete ? 'border-green-500' : 'border-gray-300'}">
                        <div class="font-semibold text-gray-700 mb-3">${title}</div>
                        
                        ${team1Players && team2Players ? `
                            <div class="space-y-3">
                                <!-- Team 1 -->
                                <div>
                                    <div class="flex flex-wrap gap-2 mb-1">
                                        ${PlayerBadge(team1Players[0])}
                                        ${PlayerBadge(team1Players[1])}
                                    </div>
                                    ${winner === 'team1' ? '<div class="text-xs text-green-600 font-semibold">üèÜ Winners</div>' : ''}
                                </div>
                                
                                <!-- Score -->
                                <div class="flex items-center gap-2 bg-gray-50 p-2 rounded">
                                    <input 
                                        type="number" 
                                        min="0" 
                                        max="${maxScore}" 
                                        value="${score.team1Score !== null ? score.team1Score : ''}"
                                        placeholder="0-${maxScore}"
                                        class="w-16 px-2 py-1 border rounded text-center"
                                        onchange="handleKnockoutScore('${matchId}', this.value, 1, ${maxScore})"
                                    />
                                    <span class="text-gray-400">-</span>
                                    <input 
                                        type="number" 
                                        min="0" 
                                        max="${maxScore}" 
                                        value="${score.team2Score !== null ? score.team2Score : ''}"
                                        placeholder="0-${maxScore}"
                                        class="w-16 px-2 py-1 border rounded text-center"
                                        onchange="handleKnockoutScore('${matchId}', this.value, 2, ${maxScore})"
                                    />
                                    ${isComplete ? `
                                        <button 
                                            onclick="state.clearKnockoutScore('${matchId}'); render();"
                                            class="ml-auto text-red-600 hover:text-red-800 font-bold"
                                            title="Clear score"
                                        >√ó</button>
                                    ` : ''}
                                </div>
                                
                                <!-- Team 2 -->
                                <div>
                                    <div class="flex flex-wrap gap-2 mb-1">
                                        ${PlayerBadge(team2Players[0])}
                                        ${PlayerBadge(team2Players[1])}
                                    </div>
                                    ${winner === 'team2' ? '<div class="text-xs text-green-600 font-semibold">üèÜ Winners</div>' : ''}
                                </div>
                            </div>
                        ` : `
                            <div class="text-sm text-gray-500 py-4 text-center">
                                Complete previous matches first
                            </div>
                        `}
                    </div>
                `;
            }
            
            return `
                <div class="space-y-6">
                    <!-- Configuration -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-lg shadow p-4">
                            <h3 class="font-semibold text-gray-800 mb-2">Quarter Finals Scoring</h3>
                            <label class="block text-sm text-gray-600 mb-1">Match Points:</label>
                            <select 
                                class="w-full border rounded px-3 py-2"
                                value="${state.knockoutMaxScore}"
                                onchange="state.updateKnockoutMaxScore(parseInt(this.value)); render();"
                            >
                                ${Array.from({length: 17}, (_, i) => i + 8).map(n => `
                                    <option value="${n}" ${state.knockoutMaxScore === n ? 'selected' : ''}>${n}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-4">
                            <h3 class="font-semibold text-gray-800 mb-2">Semi Finals Scoring</h3>
                            <label class="block text-sm text-gray-600 mb-1">Match Points:</label>
                            <select 
                                class="w-full border rounded px-3 py-2"
                                value="${state.semiMaxScore}"
                                onchange="state.updateSemiMaxScore(parseInt(this.value)); render();"
                            >
                                ${Array.from({length: 17}, (_, i) => i + 8).map(n => `
                                    <option value="${n}" ${state.semiMaxScore === n ? 'selected' : ''}>${n}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-4 bg-gradient-to-br from-yellow-50 to-orange-50">
                            <h3 class="font-semibold text-gray-800 mb-2">üèÜ Final Match Scoring</h3>
                            <label class="block text-sm text-gray-600 mb-1">Match Points:</label>
                            <select 
                                class="w-full border rounded px-3 py-2"
                                value="${state.finalMaxScore}"
                                onchange="state.updateFinalMaxScore(parseInt(this.value)); render();"
                            >
                                ${Array.from({length: 17}, (_, i) => i + 8).map(n => `
                                    <option value="${n}" ${state.finalMaxScore === n ? 'selected' : ''}>${n}</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Qualified Players -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-900 mb-3">Top 12 Qualified Players</h3>
                        <div class="flex flex-wrap gap-2">
                            ${top12.map((p, idx) => `
                                <div class="flex items-center gap-1">
                                    <span class="text-sm font-bold text-blue-900">#${idx + 1}</span>
                                    ${PlayerBadge(p.playerId)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Quarter Finals -->
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Quarter Finals</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${KnockoutMatchCard(
                                'QF1: 1st/3rd vs 10th/12th',
                                'qf1',
                                top12[0] && top12[2] ? [top12[0].playerId, top12[2].playerId] : null,
                                top12[9] && top12[11] ? [top12[9].playerId, top12[11].playerId] : null,
                                state.knockoutMaxScore
                            )}
                            ${KnockoutMatchCard(
                                'QF2: 2nd/4th vs 9th/11th',
                                'qf2',
                                top12[1] && top12[3] ? [top12[1].playerId, top12[3].playerId] : null,
                                top12[8] && top12[10] ? [top12[8].playerId, top12[10].playerId] : null,
                                state.knockoutMaxScore
                            )}
                            ${KnockoutMatchCard(
                                'QF3: 5th/7th vs 6th/8th',
                                'qf3',
                                top12[4] && top12[6] ? [top12[4].playerId, top12[6].playerId] : null,
                                top12[5] && top12[7] ? [top12[5].playerId, top12[7].playerId] : null,
                                state.knockoutMaxScore
                            )}
                            ${KnockoutMatchCard(
                                'QF4: 1st/3rd vs 10th/12th (alt)',
                                'qf4',
                                top12[0] && top12[2] ? [top12[0].playerId, top12[2].playerId] : null,
                                top12[9] && top12[11] ? [top12[9].playerId, top12[11].playerId] : null,
                                state.knockoutMaxScore
                            )}
                        </div>
                    </div>
                    
                    <!-- Semi Finals -->
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Semi Finals</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${qf1Winner && qf4Winner ? KnockoutMatchCard(
                                'SF1: QF1 Winner vs QF4 Winner',
                                'sf1',
                                qf1Winner === 'team1' ? [top12[0].playerId, top12[2].playerId] : [top12[9].playerId, top12[11].playerId],
                                qf4Winner === 'team1' ? [top12[0].playerId, top12[2].playerId] : [top12[9].playerId, top12[11].playerId],
                                state.semiMaxScore
                            ) : `
                                <div class="bg-white rounded-lg shadow-md p-4 border-2 border-gray-300">
                                    <div class="font-semibold text-gray-700 mb-3">SF1: QF1 Winner vs QF4 Winner</div>
                                    <div class="text-sm text-gray-500 py-4 text-center">
                                        Complete QF1 and QF4 first
                                    </div>
                                </div>
                            `}
                            
                            ${qf2Winner && qf3Winner ? KnockoutMatchCard(
                                'SF2: QF2 Winner vs QF3 Winner',
                                'sf2',
                                qf2Winner === 'team1' ? [top12[1].playerId, top12[3].playerId] : [top12[8].playerId, top12[10].playerId],
                                qf3Winner === 'team1' ? [top12[4].playerId, top12[6].playerId] : [top12[5].playerId, top12[7].playerId],
                                state.semiMaxScore
                            ) : `
                                <div class="bg-white rounded-lg shadow-md p-4 border-2 border-gray-300">
                                    <div class="font-semibold text-gray-700 mb-3">SF2: QF2 Winner vs QF3 Winner</div>
                                    <div class="text-sm text-gray-500 py-4 text-center">
                                        Complete QF2 and QF3 first
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Final -->
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üèÜ Championship Final</h3>
                        <div class="max-w-2xl mx-auto">
                            ${sf1Winner && sf2Winner ? `
                                ${KnockoutMatchCard(
                                    'üèÜ FINAL: SF1 Winner vs SF2 Winner',
                                    'final',
                                    // This is complex - you'd need to track SF winners properly
                                    // For now, placeholder
                                    [1, 2],
                                    [3, 4],
                                    state.finalMaxScore
                                )}
                                ${champion ? `
                                    <div class="mt-6 text-center bg-gradient-to-r from-yellow-400 to-orange-400 text-white p-8 rounded-lg shadow-xl">
                                        <div class="text-4xl mb-2">üéâ üèÜ üéâ</div>
                                        <div class="text-2xl font-bold">CHAMPIONS!</div>
                                        <div class="text-xl mt-2">
                                            Congratulations to the Winners!
                                        </div>
                                    </div>
                                ` : ''}
                            ` : `
                                <div class="bg-white rounded-lg shadow-md p-4 border-2 border-gray-300">
                                    <div class="font-semibold text-gray-700 mb-3">üèÜ FINAL</div>
                                    <div class="text-sm text-gray-500 py-4 text-center">
                                        Complete both Semi Finals first
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== EVENT HANDLERS =====
        function handleScoreChange(round, matchIdx, value, team) {
            const score = parseInt(value);
            if (isNaN(score) || score < 0 || score > 16) return;
            
            if (team === 1) {
                state.updateMatchScore(round, matchIdx, score, 16 - score);
            } else {
                state.updateMatchScore(round, matchIdx, 16 - score, score);
            }
            render();
        }

        function clearScore(round, matchIdx) {
            state.clearMatchScore(round, matchIdx);
            render();
        }

        function handleKnockoutScore(matchId, value, team, maxScore) {
            const score = parseInt(value);
            if (isNaN(score) || score < 0 || score > maxScore) return;
            
            const currentScore = state.knockoutScores[matchId] || { team1Score: null, team2Score: null };
            if (team === 1) {
                state.updateKnockoutScore(matchId, score, currentScore.team2Score);
            } else {
                state.updateKnockoutScore(matchId, currentScore.team1Score, score);
            }
            render();
        }

        function exportData() {
            const data = state.exportData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `padel-tournament-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('Tournament data exported successfully!');
        }

        function importData(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    state.importData(data);
                    render();
                    alert('Tournament data imported successfully!');
                } catch (error) {
                    alert('Error importing data. Please make sure the file is valid.');
                }
            };
            reader.readAsText(file);
        }

        function resetScores() {
            if (confirm('This will clear all match scores. A backup will be created automatically. Continue?')) {
                state.resetAllScores();
                render();
                alert('Backup saved! All scores have been reset!');
            }
        }

        function saveBackup() {
            const nameInput = document.getElementById('backup-name');
            const name = nameInput.value.trim() || `Backup ${new Date().toLocaleString()}`;
            state.createBackup(name);
            nameInput.value = '';
            render();
            alert('Version saved successfully!');
        }

        function loadVersion(versionId) {
            if (confirm('Load this version? Current state will be backed up first.')) {
                state.loadVersion(versionId);
                render();
                alert('Current state backed up! Version loaded successfully!');
            }
        }

        function deleteVersion(versionId) {
            if (confirm('Delete this saved version?')) {
                state.deleteVersion(versionId);
                render();
            }
        }

        // ===== MAIN RENDER =====
        function render() {
            const app = document.getElementById('app');
            
            const tabContent = {
                'fixtures': TournamentFixturesTab(),
                'players': PlayersTab(),
                'data': DataManagementTab(),
                'results': ResultsTab(),
                'fairness': FairnessTab(),
                'fairness2': Fairness2Tab(),
                'partnerships': PartnershipsTab(),
                'knockout': KnockoutTab()
            };
            
            app.innerHTML = `
                <div class="max-w-7xl mx-auto p-4">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-lg shadow-lg p-6 mb-6">
                        <h1 class="text-3xl font-bold mb-2">üèì Padel Tournament</h1>
                        <div class="text-sm opacity-90">24 Players ‚Ä¢ 13 Rounds ‚Ä¢ Fairness-Optimized</div>
                        <div class="text-xs opacity-75 mt-1">üíæ Auto-saved to your device</div>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="bg-white rounded-lg shadow mb-6 overflow-x-auto">
                        <div class="flex border-b min-w-max">
                            <button 
                                onclick="state.currentTab = 'fixtures'; render();"
                                class="px-6 py-3 font-medium ${state.currentTab === 'fixtures' ? 'tab-active' : 'tab-inactive'}"
                            >
                                üèÜ Tournament Fixtures
                            </button>
                            <button 
                                onclick="state.currentTab = 'players'; render();"
                                class="px-6 py-3 font-medium ${state.currentTab === 'players' ? 'tab-active' : 'tab-inactive'}"
                            >
                                üë• Player Names
                            </button>
                            <button 
                                onclick="state.currentTab = 'data'; render();"
                                class="px-6 py-3 font-medium ${state.currentTab === 'data' ? 'tab-active' : 'tab-inactive'}"
                            >
                                üíæ Data Management
                            </button>
                            <button 
                                onclick="state.currentTab = 'results'; render();"
                                class="px-6 py-3 font-medium ${state.currentTab === 'results' ? 'tab-active' : 'tab-inactive'}"
                            >
                                üìä Results & Standings
                            </button>
                            <button 
                                onclick="state.currentTab = 'fairness'; render();"
                                class="px-6 py-3 font-medium ${state.currentTab === 'fairness' ? 'tab-active' : 'tab-inactive'}"
                            >
                                ‚öñÔ∏è Fairness
                            </button>
                            <button 
                                onclick="state.currentTab = 'fairness2'; render();"
                                class="px-6 py-3 font-medium ${state.currentTab === 'fairness2' ? 'tab-active' : 'tab-inactive'}"
                            >
                                ‚öñÔ∏è Fairness 2
                            </button>
                            <button 
                                onclick="state.currentTab = 'partnerships'; render();"
                                class="px-6 py-3 font-medium ${state.currentTab === 'partnerships' ? 'tab-active' : 'tab-inactive'}"
                            >
                                ü§ù Partnerships
                            </button>
                            <button 
                                onclick="state.currentTab = 'knockout'; render();"
                                class="px-6 py-3 font-medium ${state.currentTab === 'knockout' ? 'tab-active' : 'tab-inactive'}"
                            >
                                üèÜ Knockout
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tab Content -->
                    <div>
                        ${tabContent[state.currentTab]}
                    </div>
                </div>
            `;
        }

        // Initial render
        render();
    </script>
</body>
</html>
